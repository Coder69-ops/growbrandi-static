// Advanced Analytics & Tracking System
// Implements Google Analytics 4, conversion tracking, and performance monitoring

class AnalyticsManager {
    constructor() {
        this.trackingId = null;
        this.isInitialized = false;
        this.conversionEvents = new Map();
        this.performanceMetrics = {};
        this.userJourney = [];
        this.init();
    }

    init() {
        this.setupGoogleAnalytics();
        this.setupConversionTracking();
        this.setupPerformanceMonitoring();
        this.setupUserJourneyTracking();
        this.setupHeatmapIntegration();
        this.setupFormAnalytics();
    }

    // Google Analytics 4 Setup
    setupGoogleAnalytics() {
        // Check if GA4 is already loaded
        if (window.gtag || window.dataLayer) {
            console.log('ðŸ“Š Google Analytics already initialized');
            return;
        }

        // Configure GA4 (replace with your actual tracking ID)
        const trackingId = this.getTrackingId();
        
        if (!trackingId) {
            console.log('ðŸ“Š Google Analytics tracking ID not configured');
            return;
        }

        // Load GA4 script
        const script = document.createElement('script');
        script.async = true;\n        script.src = `https://www.googletagmanager.com/gtag/js?id=${trackingId}`;\n        document.head.appendChild(script);\n\n        // Initialize dataLayer\n        window.dataLayer = window.dataLayer || [];\n        window.gtag = function() { dataLayer.push(arguments); };\n\n        // Configure GA4\n        gtag('js', new Date());\n        gtag('config', trackingId, {\n            page_title: document.title,\n            page_location: window.location.href,\n            custom_map: {\n                custom_parameter_1: 'user_type',\n                custom_parameter_2: 'source_medium'\n            },\n            // Enhanced ecommerce\n            send_page_view: true,\n            allow_google_signals: true,\n            allow_ad_personalization_signals: true\n        });\n\n        this.trackingId = trackingId;\n        this.isInitialized = true;\n        console.log('âœ… Google Analytics 4 initialized');\n    }\n\n    getTrackingId() {\n        // Try to get from config or return default for development\n        return window.GA4_TRACKING_ID || 'G-XXXXXXXXXX'; // Replace with actual ID\n    }\n\n    // Enhanced Event Tracking\n    trackEvent(eventName, parameters = {}) {\n        if (!this.isInitialized) {\n            console.warn('Analytics not initialized');\n            return;\n        }\n\n        const enhancedParams = {\n            ...parameters,\n            timestamp: Date.now(),\n            page_url: window.location.href,\n            page_title: document.title,\n            user_id: this.getUserId(),\n            session_id: this.getSessionId()\n        };\n\n        if (window.gtag) {\n            gtag('event', eventName, enhancedParams);\n        }\n\n        console.log(`ðŸ“ˆ Event tracked: ${eventName}`, enhancedParams);\n    }\n\n    // Conversion Tracking\n    setupConversionTracking() {\n        // Define conversion events\n        this.conversionEvents.set('contact_form_submit', {\n            currency: 'USD',\n            value: 100, // Estimated lead value\n            event_category: 'engagement',\n            event_label: 'contact_form'\n        });\n\n        this.conversionEvents.set('chat_started', {\n            currency: 'USD',\n            value: 50,\n            event_category: 'engagement',\n            event_label: 'ai_chat'\n        });\n\n        this.conversionEvents.set('service_viewed', {\n            event_category: 'engagement',\n            event_label: 'service_page'\n        });\n\n        this.conversionEvents.set('consultation_requested', {\n            currency: 'USD',\n            value: 500,\n            event_category: 'conversion',\n            event_label: 'consultation'\n        });\n    }\n\n    trackConversion(eventName, additionalParams = {}) {\n        const conversionData = this.conversionEvents.get(eventName);\n        if (!conversionData) {\n            console.warn(`Unknown conversion event: ${eventName}`);\n            return;\n        }\n\n        const params = {\n            ...conversionData,\n            ...additionalParams,\n            conversion_id: this.generateConversionId(),\n            conversion_time: new Date().toISOString()\n        };\n\n        this.trackEvent(eventName, params);\n\n        // Track enhanced ecommerce if applicable\n        if (params.value) {\n            this.trackPurchase(eventName, params);\n        }\n    }\n\n    trackPurchase(eventName, params) {\n        if (window.gtag) {\n            gtag('event', 'purchase', {\n                transaction_id: params.conversion_id,\n                value: params.value,\n                currency: params.currency || 'USD',\n                items: [{\n                    item_id: eventName,\n                    item_name: eventName.replace('_', ' '),\n                    category: params.event_category,\n                    quantity: 1,\n                    price: params.value\n                }]\n            });\n        }\n    }\n\n    // Performance Monitoring\n    setupPerformanceMonitoring() {\n        // Core Web Vitals\n        this.observeWebVitals();\n        \n        // Custom performance metrics\n        window.addEventListener('load', () => {\n            this.trackPagePerformance();\n        });\n\n        // Error tracking\n        window.addEventListener('error', (event) => {\n            this.trackError(event.error, 'javascript_error');\n        });\n\n        window.addEventListener('unhandledrejection', (event) => {\n            this.trackError(event.reason, 'promise_rejection');\n        });\n    }\n\n    observeWebVitals() {\n        // Observe Core Web Vitals\n        const observer = new PerformanceObserver((list) => {\n            list.getEntries().forEach((entry) => {\n                if (entry.entryType === 'largest-contentful-paint') {\n                    this.trackEvent('web_vital_lcp', {\n                        value: Math.round(entry.startTime),\n                        metric_type: 'largest_contentful_paint'\n                    });\n                }\n            });\n        });\n\n        try {\n            observer.observe({ entryTypes: ['largest-contentful-paint'] });\n        } catch (e) {\n            console.warn('Performance Observer not supported');\n        }\n    }\n\n    trackPagePerformance() {\n        const navigation = performance.getEntriesByType('navigation')[0];\n        if (!navigation) return;\n\n        const metrics = {\n            page_load_time: Math.round(navigation.loadEventEnd - navigation.fetchStart),\n            dom_content_loaded: Math.round(navigation.domContentLoadedEventEnd - navigation.fetchStart),\n            first_byte: Math.round(navigation.responseStart - navigation.fetchStart),\n            dom_interactive: Math.round(navigation.domInteractive - navigation.fetchStart)\n        };\n\n        this.performanceMetrics = metrics;\n\n        this.trackEvent('page_performance', {\n            ...metrics,\n            connection_type: this.getConnectionType()\n        });\n    }\n\n    trackError(error, errorType) {\n        const errorData = {\n            error_message: error.message || String(error),\n            error_stack: error.stack || '',\n            error_type: errorType,\n            page_url: window.location.href,\n            user_agent: navigator.userAgent,\n            timestamp: new Date().toISOString()\n        };\n\n        this.trackEvent('javascript_error', errorData);\n\n        // Also send to error reporting service if configured\n        if (window.Sentry) {\n            window.Sentry.captureException(error);\n        }\n    }\n\n    // User Journey Tracking\n    setupUserJourneyTracking() {\n        // Track page views\n        this.trackPageView();\n\n        // Track scroll depth\n        this.trackScrollDepth();\n\n        // Track time on page\n        this.trackTimeOnPage();\n\n        // Track click heatmap data\n        this.trackClicks();\n    }\n\n    trackPageView() {\n        const pageData = {\n            page_title: document.title,\n            page_location: window.location.href,\n            page_path: window.location.pathname,\n            referrer: document.referrer,\n            timestamp: Date.now()\n        };\n\n        this.userJourney.push({\n            type: 'page_view',\n            ...pageData\n        });\n\n        this.trackEvent('page_view', pageData);\n    }\n\n    trackScrollDepth() {\n        let maxScroll = 0;\n        const milestones = [25, 50, 75, 90, 100];\n        const trackedMilestones = new Set();\n\n        const trackScroll = () => {\n            const scrollPercent = Math.round(\n                (window.scrollY + window.innerHeight) / document.body.scrollHeight * 100\n            );\n\n            maxScroll = Math.max(maxScroll, scrollPercent);\n\n            milestones.forEach(milestone => {\n                if (scrollPercent >= milestone && !trackedMilestones.has(milestone)) {\n                    trackedMilestones.add(milestone);\n                    this.trackEvent('scroll_depth', {\n                        percent: milestone,\n                        page_path: window.location.pathname\n                    });\n                }\n            });\n        };\n\n        let ticking = false;\n        window.addEventListener('scroll', () => {\n            if (!ticking) {\n                requestAnimationFrame(() => {\n                    trackScroll();\n                    ticking = false;\n                });\n                ticking = true;\n            }\n        });\n    }\n\n    trackTimeOnPage() {\n        const startTime = Date.now();\n        let isActive = true;\n\n        // Track when user becomes inactive\n        let inactiveTime = 0;\n        let lastActivity = startTime;\n\n        const trackActivity = () => {\n            lastActivity = Date.now();\n            isActive = true;\n        };\n\n        document.addEventListener('mousemove', trackActivity);\n        document.addEventListener('keypress', trackActivity);\n        document.addEventListener('scroll', trackActivity);\n        document.addEventListener('click', trackActivity);\n\n        // Check for inactivity every 30 seconds\n        setInterval(() => {\n            const now = Date.now();\n            if (now - lastActivity > 30000) { // 30 seconds of inactivity\n                isActive = false;\n            }\n        }, 30000);\n\n        // Send time on page when user leaves\n        window.addEventListener('beforeunload', () => {\n            const totalTime = Date.now() - startTime;\n            const activeTime = totalTime - inactiveTime;\n\n            this.trackEvent('time_on_page', {\n                total_time: Math.round(totalTime / 1000),\n                active_time: Math.round(activeTime / 1000),\n                page_path: window.location.pathname\n            });\n        });\n    }\n\n    trackClicks() {\n        document.addEventListener('click', (event) => {\n            const element = event.target;\n            const tagName = element.tagName.toLowerCase();\n            const clickData = {\n                element_tag: tagName,\n                element_id: element.id || '',\n                element_class: element.className || '',\n                element_text: element.textContent?.substring(0, 100) || '',\n                click_x: event.clientX,\n                click_y: event.clientY,\n                page_path: window.location.pathname\n            };\n\n            // Track specific interactions\n            if (tagName === 'button' || tagName === 'a') {\n                this.trackEvent('click_interaction', clickData);\n            }\n\n            // Track CTA clicks\n            if (element.classList.contains('btn') || element.classList.contains('cta')) {\n                this.trackEvent('cta_click', {\n                    ...clickData,\n                    cta_type: element.classList.contains('btn-primary') ? 'primary' : 'secondary'\n                });\n            }\n        });\n    }\n\n    // Heatmap Integration (Hotjar, Clarity, etc.)\n    setupHeatmapIntegration() {\n        // Microsoft Clarity integration\n        if (window.clarity) {\n            window.clarity('consent');\n        } else {\n            // Load Clarity if not already loaded\n            const clarityId = this.getClarityId();\n            if (clarityId) {\n                this.loadClarity(clarityId);\n            }\n        }\n\n        // Hotjar integration\n        const hotjarId = this.getHotjarId();\n        if (hotjarId && !window.hj) {\n            this.loadHotjar(hotjarId);\n        }\n    }\n\n    getClarityId() {\n        return window.CLARITY_ID || null;\n    }\n\n    getHotjarId() {\n        return window.HOTJAR_ID || null;\n    }\n\n    loadClarity(clarityId) {\n        (function(c,l,a,r,i,t,y){\n            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};\n            t=l.createElement(r);t.async=1;t.src=\"https://www.clarity.ms/tag/\"+i;\n            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);\n        })(window, document, \"clarity\", \"script\", clarityId);\n    }\n\n    loadHotjar(hotjarId) {\n        (function(h,o,t,j,a,r){\n            h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};\n            h._hjSettings={hjid:hotjarId,hjsv:6};\n            a=o.getElementsByTagName('head')[0];\n            r=o.createElement('script');r.async=1;\n            r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;\n            a.appendChild(r);\n        })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');\n    }\n\n    // Form Analytics\n    setupFormAnalytics() {\n        document.querySelectorAll('form').forEach(form => {\n            this.trackFormInteractions(form);\n        });\n    }\n\n    trackFormInteractions(form) {\n        const formId = form.id || form.className || 'unknown_form';\n        const startTime = Date.now();\n        let fieldInteractions = {};\n\n        // Track form start\n        const trackFormStart = () => {\n            this.trackEvent('form_start', {\n                form_id: formId,\n                form_url: window.location.href\n            });\n        };\n\n        // Track field interactions\n        form.querySelectorAll('input, textarea, select').forEach(field => {\n            const fieldName = field.name || field.id || field.type;\n            \n            field.addEventListener('focus', () => {\n                if (!fieldInteractions[fieldName]) {\n                    fieldInteractions[fieldName] = {\n                        focused: Date.now(),\n                        changed: false\n                    };\n                    trackFormStart();\n                }\n            });\n\n            field.addEventListener('blur', () => {\n                if (fieldInteractions[fieldName]) {\n                    fieldInteractions[fieldName].blurred = Date.now();\n                    const timeSpent = fieldInteractions[fieldName].blurred - fieldInteractions[fieldName].focused;\n                    \n                    this.trackEvent('form_field_interaction', {\n                        form_id: formId,\n                        field_name: fieldName,\n                        time_spent: Math.round(timeSpent),\n                        field_changed: fieldInteractions[fieldName].changed\n                    });\n                }\n            });\n\n            field.addEventListener('change', () => {\n                if (fieldInteractions[fieldName]) {\n                    fieldInteractions[fieldName].changed = true;\n                }\n            });\n        });\n\n        // Track form submission\n        form.addEventListener('submit', () => {\n            const totalTime = Date.now() - startTime;\n            const fieldCount = Object.keys(fieldInteractions).length;\n            \n            this.trackEvent('form_submit', {\n                form_id: formId,\n                total_time: Math.round(totalTime),\n                fields_interacted: fieldCount,\n                form_url: window.location.href\n            });\n\n            // Track as conversion if it's a contact form\n            if (formId.includes('contact') || formId.includes('consultation')) {\n                this.trackConversion('contact_form_submit', {\n                    form_id: formId,\n                    completion_time: Math.round(totalTime)\n                });\n            }\n        });\n    }\n\n    // Utility functions\n    getUserId() {\n        // Generate or retrieve user ID\n        let userId = localStorage.getItem('analytics_user_id');\n        if (!userId) {\n            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n            localStorage.setItem('analytics_user_id', userId);\n        }\n        return userId;\n    }\n\n    getSessionId() {\n        // Generate or retrieve session ID\n        let sessionId = sessionStorage.getItem('analytics_session_id');\n        if (!sessionId) {\n            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n            sessionStorage.setItem('analytics_session_id', sessionId);\n        }\n        return sessionId;\n    }\n\n    generateConversionId() {\n        return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n    }\n\n    getConnectionType() {\n        if ('connection' in navigator) {\n            return navigator.connection.effectiveType || 'unknown';\n        }\n        return 'unknown';\n    }\n\n    // Public API methods\n    trackCustomEvent(eventName, parameters) {\n        this.trackEvent(eventName, parameters);\n    }\n\n    trackCustomConversion(eventName, value, currency = 'USD') {\n        this.trackConversion(eventName, { value, currency });\n    }\n\n    getAnalyticsData() {\n        return {\n            userJourney: this.userJourney,\n            performanceMetrics: this.performanceMetrics,\n            userId: this.getUserId(),\n            sessionId: this.getSessionId()\n        };\n    }\n}\n\n// Initialize analytics\nconst analyticsManager = new AnalyticsManager();\n\n// Export for global use\nwindow.analyticsManager = analyticsManager;\n\n// Helper function for easy event tracking\nwindow.trackEvent = (eventName, parameters) => {\n    analyticsManager.trackCustomEvent(eventName, parameters);\n};\n\n// Helper function for conversion tracking\nwindow.trackConversion = (eventName, value, currency) => {\n    analyticsManager.trackCustomConversion(eventName, value, currency);\n};\n\nconsole.log('ðŸ“Š Advanced analytics system initialized');